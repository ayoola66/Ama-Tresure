<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Ama Treasure Adventure</title>
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        overflow: hidden;
        background: linear-gradient(to bottom right, #87ceeb, #f08080);
      }

      #game-container {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: #1a1a1a;
        padding: 20px;
      }

      .game-stats {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1000;
        color: white;
        font-size: 14px;
        display: flex;
        gap: 15px;
      }

      .game-header-button {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 10px 20px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.2s;
        z-index: 1000;
        border: none;
      }

      .game-header-button:hover {
        background: rgba(0, 0, 0, 0.9);
        transform: translateX(-50%) translateY(-2px);
      }

      #startscreen {
        position: fixed;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 30px;
        border-radius: 15px;
        text-align: center;
        width: 90%;
        max-width: 600px;
        z-index: 1000;
        max-height: 90vh;
        overflow-y: auto;
      }

      #game {
        position: relative;
        width: 80vw;
        height: 80vh;
        border: 10px solid rgba(0, 0, 0, 0.8);
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
        background-image: url("https://st4.depositphotos.com/1000673/25687/v/450/depositphotos_256875936-stock-illustration-treasure-island-background-for-game.jpg");
        background-size: cover;
        background-position: center;
      }

      .game-title {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 32px;
        font-weight: bold;
        background: linear-gradient(
          to right,
          #462523 0%,
          #cb9b51 22%,
          #f6e27a 45%,
          #f6f2c0 50%,
          #f6e27a 55%,
          #cb9b51 78%,
          #462523 100%
        );
        background-size: 600px;
        background-clip: text;
        -webkit-background-clip: text;
        color: transparent;
        -webkit-text-fill-color: transparent;
        animation: shine 3s infinite linear;
        z-index: 1000;
      }

      @keyframes shine {
        0% {
          background-position: 0;
        }
        60% {
          background-position: 600px;
        }
        100% {
          background-position: 600px;
        }
      }

      .audio-controls-collapsed {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.85);
        padding: 10px;
        border-radius: 50%;
        cursor: pointer;
        z-index: 1001;
        border: none;
        color: white;
        font-size: 20px;
      }

      #audioControls {
        position: fixed;
        top: 70px;
        right: 20px;
        background: rgba(0, 0, 0, 0.9);
        padding: 20px;
        border-radius: 12px;
        color: white;
        z-index: 1000;
        backdrop-filter: blur(5px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        min-width: 250px;
        transform-origin: top right;
        transition: transform 0.3s ease;
      }

      #audioControls.collapsed {
        transform: scale(0);
      }

      .toggle-audio {
        position: absolute;
        top: 5px;
        right: 5px;
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        font-size: 16px;
        padding: 5px;
      }

      .sprite {
        position: absolute;
        font-size: 50px;
        transition: all 0.1s ease-out;
        will-change: transform;
        z-index: 2;
      }

      #player1,
      #player2 {
        display: none;
      }

      .obstacle {
        font-size: 60px;
        z-index: 1;
      }

      .power-up {
        font-size: 40px;
        animation: float 2s infinite ease-in-out;
      }

      @keyframes float {
        0% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-10px);
        }
        100% {
          transform: translateY(0px);
        }
      }

      #scoreboard {
        position: absolute;
        top: 10px;
        left: 10px;
        font-size: 16px;
        font-weight: bold;
        background: rgba(255, 255, 255, 0.9);
        padding: 10px 15px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        line-height: 1.4em;
        display: none;
      }

      #gameover,
      #achievement {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        font-weight: bold;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 30px;
        text-align: center;
        border-radius: 15px;
        width: 90%;
        max-width: 400px;
        z-index: 1000;
      }

      #gameover {
        display: none;
      }

      #achievement {
        top: 20%;
        font-size: 18px;
        background: rgba(0, 150, 0, 0.9);
        display: none;
      }

      #startscreen p {
        font-size: 20px;
        margin: 15px 0;
      }

      #startscreen input[type="text"] {
        font-size: 18px;
        margin: 10px 0;
        padding: 12px 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        width: 80%;
        max-width: 300px;
      }

      #startscreen input[type="text"]:focus {
        outline: none;
        border-color: orange;
        background: rgba(255, 255, 255, 0.2);
      }

      #startscreen input[type="text"]::placeholder {
        color: rgba(255, 255, 255, 0.6);
      }

      .mode-selection {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin: 20px 0;
        flex-wrap: wrap;
      }

      .mode-button {
        padding: 20px 30px;
        font-size: 18px;
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 220px;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }

      .mode-button:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-3px);
      }

      .mode-button.selected {
        background: rgba(255, 165, 0, 0.4);
        border-color: orange;
        transform: scale(1.05);
        box-shadow: 0 0 20px rgba(255, 165, 0, 0.4);
      }

      .mode-button .icon {
        font-size: 36px;
      }

      .mode-button .description {
        font-size: 14px;
        opacity: 0.8;
      }

      #gameover button,
      #startscreen button {
        font-size: 22px;
        padding: 15px 30px;
        margin-top: 20px;
        border: none;
        border-radius: 10px;
        background: linear-gradient(45deg, #ff6b35, #f7931e);
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: bold;
      }

      #gameover button:hover,
      #startscreen button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
      }

      #avatarChoicesP1 span,
      #avatarChoicesP2 span {
        cursor: pointer;
        font-size: 40px;
        margin: 8px;
        padding: 12px;
        border-radius: 8px;
        display: inline-block;
        transition: all 0.2s ease;
      }

      #avatarChoicesP1 span:hover,
      #avatarChoicesP2 span:hover {
        transform: scale(1.1);
      }

      #avatarChoicesP1 span.selected,
      #avatarChoicesP2 span.selected {
        background: rgba(255, 165, 0, 0.3);
        border: 3px solid orange;
        transform: scale(1.1);
      }

      .music-player {
        position: fixed;
        right: 20px;
        top: 200px;
        z-index: 1000;
      }

      .play-pause-button {
        background: rgba(0, 0, 0, 0.8);
        padding: 15px;
        border-radius: 12px;
        color: white;
        text-align: center;
        cursor: pointer;
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
        border: none;
      }

      .play-pause-button:hover {
        background: rgba(0, 0, 0, 0.9);
        transform: translateY(-2px);
      }

      .play-icon {
        font-size: 24px;
        margin-bottom: 5px;
      }

      .text {
        font-size: 12px;
      }

      @keyframes breathing {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }

      .breathing {
        animation: breathing 2s infinite ease-in-out;
      }

      #audioControls .control-row {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 15px 0;
      }

      #audioControls .icon {
        font-size: 18px;
        width: 25px;
        text-align: center;
      }

      #audioControls input[type="range"] {
        flex: 1;
        height: 6px;
        appearance: none;
        -webkit-appearance: none;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 3px;
        outline: none;
      }

      #audioControls input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 18px;
        height: 18px;
        background: white;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      #audioControls input[type="range"]::-webkit-slider-thumb:hover {
        transform: scale(1.2);
      }

      #audioControls button {
        width: 100%;
        padding: 12px;
        margin-top: 15px;
        border: none;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 14px;
      }

      #audioControls button:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .volume-value {
        min-width: 45px;
        text-align: right;
        font-size: 12px;
        color: rgba(255, 255, 255, 0.9);
        font-family: monospace;
      }

      #how-to-play {
        text-align: left;
        font-size: 16px;
        line-height: 1.6em;
        margin: 20px 0;
      }

      #how-to-play summary {
        cursor: pointer;
        font-size: 24px;
        margin-bottom: 15px;
        text-align: center;
        color: orange;
      }

      .level-up {
        position: absolute;
        left: 50%;
        top: 40%;
        transform: translate(-50%, -50%);
        background: rgba(0, 255, 0, 0.9);
        color: white;
        padding: 20px;
        border-radius: 10px;
        font-size: 24px;
        z-index: 1000;
        animation: fadeInOut 2s ease-in-out;
      }

      @keyframes fadeInOut {
        0% {
          opacity: 0;
          transform: translate(-50%, -50%) scale(0.8);
        }
        15% {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1.1);
        }
        30% {
          transform: translate(-50%, -50%) scale(1);
        }
        70% {
          opacity: 1;
        }
        100% {
          opacity: 0;
        }
      }
    </style>
  </head>
  <body>
    <div id="game-container">
      <div class="game-stats">
        <div>‚è≥ Time: <span id="timeDisplay">40</span></div>
        <div>üèÜ Level: <span id="levelDisplay">1</span></div>
        <div>‚≠ê High Score: <span id="highScoreDisplay">0</span></div>
        <div id="playerStats"></div>
      </div>

      <button class="audio-controls-collapsed" id="toggleAudio">üéß</button>

      <button id="pauseButton" class="game-header-button">
        EXIT/PAUSE GAME
      </button>

      <div id="game">
        <div id="player1" class="sprite">üßú‚Äç‚ôÄÔ∏è</div>
        <div id="player2" class="sprite">üßë‚ÄçüöÄ</div>
        <div id="treasure" class="sprite">üí∞</div>
        <div id="scoreboard"></div>
        <div id="gameover"></div>
        <div id="achievement"></div>
      </div>

      <div id="startscreen">
        <p>üèùÔ∏è Treasure Island Adventure üèùÔ∏è</p>
        <div class="mode-selection">
          <button class="mode-button selected" data-mode="1">
            <span class="icon">ü§π‚Äç‚ôÇÔ∏è</span>
            <span class="label">Single Player</span>
            <span class="description">Challenge yourself in solo mode!</span>
          </button>
          <button class="mode-button" data-mode="2">
            <span class="icon">ü§∏‚Äç‚ôÇÔ∏èü§∏‚Äç‚ôÄÔ∏è</span>
            <span class="label">Two Players</span>
            <span class="description">Compete with a friend!</span>
          </button>
        </div>

        <p>Enter Player 1 name:</p>
        <input id="player1Name" type="text" placeholder="Player 1 name" />

        <div id="player2Settings" style="display: none">
          <p>Enter Player 2 name:</p>
          <input id="player2Name" type="text" placeholder="Player 2 name" />
        </div>

        <p>Select Player 1 avatar:</p>
        <div id="avatarChoicesP1"></div>

        <div id="player2AvatarSelect" style="display: none">
          <p>Select Player 2 avatar:</p>
          <div id="avatarChoicesP2"></div>
        </div>

        <details id="how-to-play">
          <summary>How to Play</summary>
          <p>
            The objective is to navigate the island, collect treasure, and level
            up before time runs out.
          </p>
          <p>
            <strong>1. Controls</strong><br />
            - <strong>Player 1:</strong> Use the
            <strong>Arrow Keys</strong> (Up, Down, Left, Right).<br />
            - <strong>Player 2:</strong> Use the <strong>WASD</strong> keys
            (W=Up, A=Left, S=Down, D=Right).
          </p>
          <p>
            <strong>2. Gameplay</strong><br />
            - <strong>Treasure:</strong> Run into the üí∞ to collect it. Each one
            adds one point to your score.<br />
            - <strong>Obstacles:</strong> Avoid the moving obstacles like üêä,
            üî•, and ü••. Colliding with one decreases your lives.<br />
            - <strong>End of Game:</strong> The game ends when your lives run
            out or the timer hits zero.
          </p>
          <p>
            <strong>3. Special Bonuses</strong><br />
            - <strong>Level Up:</strong> Every 5 points, you level up and get 10
            extra seconds.<br />
            - <strong>Time Bonus:</strong> Once you reach 15 points, you'll earn
            an extra 5 seconds for every 5 points thereafter.<br />
            - <strong>Bonus Life:</strong> You get a bonus life at Level 6.
          </p>
        </details>

        <button onclick="startGame()">Play</button>
      </div>

      <div class="game-title">AMA TREASURE ADVENTURE</div>
    </div>

    <div class="music-player">
      <button class="play-pause-button breathing">
        <div class="play-icon">‚ñ∂</div>
        <div class="text">Play/Pause Music</div>
      </button>
    </div>

    <div id="audioControls" class="collapsed">
      <button class="toggle-audio" id="collapseAudio">‚úñ</button>
      <div class="control-row">
        <span class="icon">üéµ</span>
        <input type="range" id="musicVolume" min="0" max="100" value="50" />
        <span class="volume-value" id="musicVolumeValue">50%</span>
      </div>
      <div class="control-row">
        <span class="icon">üéÆ</span>
        <input type="range" id="fxVolume" min="0" max="100" value="70" />
        <span class="volume-value" id="fxVolumeValue">70%</span>
      </div>
      <button id="muteButton">Mute All üîá</button>
    </div>

    <!-- Audio Elements -->
    <audio id="backgroundMusic" loop preload="auto">
      <source src="data/audio/background.mp3" type="audio/mpeg" />
    </audio>
    <audio id="treasureCoinSound" preload="auto">
      <source src="data/audio/treasure_coin.mp3" type="audio/mpeg" />
    </audio>
    <audio id="treasureSilverSound" preload="auto">
      <source src="data/audio/treasure_silver.mp3" type="audio/mpeg" />
    </audio>
    <audio id="treasureGoldSound" preload="auto">
      <source src="data/audio/treasure_gold.mp3" type="audio/mpeg" />
    </audio>
    <audio id="treasureGemSound" preload="auto">
      <source src="data/audio/treasure_gem.mp3" type="audio/mpeg" />
    </audio>
    <audio id="obstacleSound" preload="auto">
      <source src="data/audio/obstacle.mp3" type="audio/mpeg" />
    </audio>
    <audio id="gameOverSound" preload="auto">
      <source src="data/audio/gameover.mp3" type="audio/mpeg" />
    </audio>
    <audio id="achievementSound" preload="auto">
      <source src="data/audio/achievement.mp3" type="audio/mpeg" />
    </audio>
    <audio id="powerupSound" preload="auto">
      <source src="data/audio/powerup.mp3" type="audio/mpeg" />
    </audio>
    <audio id="menuClickSound" preload="auto">
      <source src="data/audio/menu_click.mp3" type="audio/mpeg" />
    </audio>

    <script>
      // Debug helper
      window.onerror = function (msg, url, lineNo, columnNo, error) {
        console.error(
          "Error: " + msg + "\nLine: " + lineNo + "\nColumn: " + columnNo
        );
        return false;
      };
    </script>
    <script src="game_fixes.js"></script>
    <script>
      // Game Elements
      const player1 = document.getElementById("player1");
      const player2 = document.getElementById("player2");
      const treasure = document.getElementById("treasure");
      const scoreboard = document.getElementById("scoreboard");
      const gameover = document.getElementById("gameover");
      const startscreen = document.getElementById("startscreen");
      const achievementBox = document.getElementById("achievement");
      const gameContainer = document.getElementById("game");

      // Audio elements
      const backgroundMusic = document.getElementById("backgroundMusic");
      const obstacleSound = document.getElementById("obstacleSound");
      const gameOverSound = document.getElementById("gameOverSound");
      const achievementSound = document.getElementById("achievementSound");
      const muteButton = document.getElementById("muteButton");

      // Game State
      let obstacles = [];
      let powerUps = [];
      const avatarOptions = ["üßú‚Äç‚ôÄÔ∏è", "üßë‚ÄçüöÄ", "üö¥", "üßô‚Äç‚ôÇÔ∏è", "üßô‚Äç‚ôÄÔ∏è"];
      let mode = 1;
      let gameInitialized = false;

      const powerUpTypes = {
        SPEED: { emoji: "‚ö°", duration: 5, effect: "2x Speed", minLevel: 1 },
        SHIELD: {
          emoji: "üõ°Ô∏è",
          duration: 8,
          effect: "Temporary Invincibility",
          minLevel: 2,
        },
        MAGNET: {
          emoji: "üß≤",
          duration: 6,
          effect: "Attract Treasures",
          minLevel: 3,
        },
        POINTS: { emoji: "‚ú®", duration: 7, effect: "2x Points", minLevel: 4 },
      };

      const treasureTypes = {
        COIN: {
          emoji: "üí∞",
          points: 1,
          rarity: 0.6,
          sound: "treasureCoinSound",
        },
        SILVER: {
          emoji: "‚ö™",
          points: 3,
          rarity: 0.25,
          sound: "treasureSilverSound",
        },
        GOLD: {
          emoji: "üåü",
          points: 5,
          rarity: 0.1,
          sound: "treasureGoldSound",
        },
        GEM: {
          emoji: "üíé",
          points: 10,
          rarity: 0.05,
          sound: "treasureGemSound",
        },
      };

      const levelSettings = {
        baseSpeed: 2,
        trackingRange: 300,
        baseTrackingStrength: 0.2,
        trackingLevelBonus: 0.1,
        respawnDelay: 8000,
      };

      // Game Variables
      let p1Name, p2Name;
      let p1Score,
        p2Score,
        p1Lives,
        p2Lives,
        timeLeft,
        level,
        obstacleSpeed,
        timer;
      let p1X, p1Y, p2X, p2Y;
      const moveStep = 20;
      let highScore = localStorage.getItem("treasureHighScore") || 0;

      // Audio settings
      let musicVolume = 0.5;
      let fxVolume = 0.7;
      let isMuted = false;
      let audioInitialized = false;
      let previousMusicVolume = 0.5;
      let previousFxVolume = 0.7;
      let isPlaying = false;
      let isPaused = false;

      // Player direction states
      let p1Direction = "right";
      let p2Direction = "right";

      // Initialize the game
      function initializeGame() {
        if (gameInitialized) return;

        console.log("Initializing game...");

        // Load avatar choices
        loadAvatarChoices();

        // Initialize mode selection
        initializeModeSelection();

        // Set up audio controls
        setupAudioControls();

        // Initialize start screen
        startscreen.style.display = "block";

        // Hide game elements initially
        player1.style.display = "none";
        player2.style.display = "none";
        treasure.style.display = "none";
        document.getElementById("pauseButton").style.display = "none";

        gameInitialized = true;
        console.log("Game initialized successfully");
      }

      function loadAvatarChoices() {
        const p1Div = document.getElementById("avatarChoicesP1");
        const p2Div = document.getElementById("avatarChoicesP2");

        p1Div.innerHTML = "";
        p2Div.innerHTML = "";

        avatarOptions.forEach((av) => {
          const span1 = document.createElement("span");
          span1.innerText = av;
          span1.onclick = () => selectAvatar(span1, "p1");
          p1Div.appendChild(span1);

          const span2 = document.createElement("span");
          span2.innerText = av;
          span2.onclick = () => selectAvatar(span2, "p2");
          p2Div.appendChild(span2);
        });

        // Select first avatar by default
        if (p1Div.children.length > 0) {
          p1Div.children[0].classList.add("selected");
        }
        if (p2Div.children.length > 0) {
          p2Div.children[0].classList.add("selected");
        }
      }

      function selectAvatar(span, player) {
        if (player === "p1") {
          document
            .querySelectorAll("#avatarChoicesP1 span")
            .forEach((s) => s.classList.remove("selected"));
          span.classList.add("selected");
        } else {
          document
            .querySelectorAll("#avatarChoicesP2 span")
            .forEach((s) => s.classList.remove("selected"));
          span.classList.add("selected");
        }
      }

      function initializeModeSelection() {
        // Mode selection handling
        document.querySelectorAll(".mode-button").forEach((button) => {
          button.addEventListener("click", () => {
            document
              .querySelectorAll(".mode-button")
              .forEach((b) => b.classList.remove("selected"));
            button.classList.add("selected");
            mode = parseInt(button.dataset.mode);
            playAudio(document.getElementById("menuClickSound"));

            // Show/hide player 2 settings
            const player2Settings = document.getElementById("player2Settings");
            const player2AvatarSelect = document.getElementById(
              "player2AvatarSelect"
            );

            if (mode === 2) {
              player2Settings.style.display = "block";
              player2AvatarSelect.style.display = "block";
            } else {
              player2Settings.style.display = "none";
              player2AvatarSelect.style.display = "none";
            }
          });
        });
      }

      function setupAudioControls() {
        // Preload all audio
        const audioElements = document.querySelectorAll("audio");
        audioElements.forEach((audio) => audio.load());

        // Audio panel toggle
        document.getElementById("toggleAudio").addEventListener("click", () => {
          const panel = document.getElementById("audioControls");
          panel.classList.remove("collapsed");
        });

        document
          .getElementById("collapseAudio")
          .addEventListener("click", () => {
            const panel = document.getElementById("audioControls");
            panel.classList.add("collapsed");
          });

        // Music/FX volume controls
        document
          .getElementById("musicVolume")
          .addEventListener("input", (e) => {
            musicVolume = e.target.value / 100;
            previousMusicVolume = musicVolume;
            document.getElementById("musicVolumeValue").textContent =
              e.target.value + "%";
            updateAudioVolumes();
            if (musicVolume > 0) isMuted = false;
          });

        document.getElementById("fxVolume").addEventListener("input", (e) => {
          fxVolume = e.target.value / 100;
          previousFxVolume = fxVolume;
          document.getElementById("fxVolumeValue").textContent =
            e.target.value + "%";
          updateAudioVolumes();
        });

        // Mute button
        muteButton.addEventListener("click", () => {
          isMuted = !isMuted;
          if (isMuted) {
            previousMusicVolume = musicVolume;
            previousFxVolume = fxVolume;
            document.getElementById("musicVolume").value = 0;
            document.getElementById("fxVolume").value = 0;
            document.getElementById("musicVolumeValue").textContent = "0%";
            document.getElementById("fxVolumeValue").textContent = "0%";
            musicVolume = 0;
            fxVolume = 0;
          } else {
            document.getElementById("musicVolume").value =
              previousMusicVolume * 100;
            document.getElementById("fxVolume").value = previousFxVolume * 100;
            document.getElementById("musicVolumeValue").textContent =
              Math.round(previousMusicVolume * 100) + "%";
            document.getElementById("fxVolumeValue").textContent =
              Math.round(previousFxVolume * 100) + "%";
            musicVolume = previousMusicVolume;
            fxVolume = previousFxVolume;
          }
          updateAudioVolumes();
          muteButton.innerText = isMuted ? "Unmute üîä" : "Mute üîá";
        });

        // Play/Pause button
        document
          .querySelector(".play-pause-button")
          .addEventListener("click", () => {
            isPlaying = !isPlaying;
            updatePlayPauseButton();
            if (isPlaying) {
              backgroundMusic
                .play()
                .catch((e) => console.log("Audio play failed:", e));
            } else {
              backgroundMusic.pause();
            }
          });

        // Pause button
        document
          .getElementById("pauseButton")
          .addEventListener("click", pauseGame);

        // Escape key pauses/resumes
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") pauseGame();
        });

        // Initialize audio on first user interaction
        document.addEventListener("click", initAudio, { once: true });
      }

      function initAudio() {
        if (audioInitialized) return;

        console.log("Initializing audio...");
        const audioElements = document.querySelectorAll("audio");
        audioElements.forEach((audio) => audio.load());

        audioInitialized = true;
        isPlaying = false;
        updatePlayPauseButton();

        backgroundMusic.volume = musicVolume;
        backgroundMusic.loop = true;
        updateAudioVolumes();

        console.log("Audio initialized");
      }

      function updateAudioVolumes() {
        if (!audioInitialized) return;

        const allAudio = document.querySelectorAll("audio");
        allAudio.forEach((audio) => {
          if (isMuted) {
            audio.volume = 0;
          } else {
            if (audio.id === "backgroundMusic") {
              audio.volume = musicVolume;
            } else {
              audio.volume = fxVolume;
            }
          }
        });
      }

      function updatePlayPauseButton() {
        const button = document.querySelector(".play-pause-button");
        const icon = button.querySelector(".play-icon");
        icon.textContent = isPlaying ? "‚è∏" : "‚ñ∂";
        button.classList.toggle("breathing", !isPlaying);
      }

      function playAudio(audioElement, volume = null) {
        if (!audioElement) return;

        try {
          if (volume !== null) {
            audioElement.volume = isMuted ? 0 : volume;
          } else if (audioElement.id === "backgroundMusic") {
            audioElement.volume = isMuted ? 0 : musicVolume;
          } else {
            audioElement.volume = isMuted ? 0 : fxVolume;
          }

          audioElement.currentTime = 0;

          const playPromise = audioElement.play();
          if (playPromise !== undefined) {
            playPromise.catch((error) => {
              console.log("Audio playback error:", error);
            });
          }
        } catch (error) {
          console.log("Audio playback error:", error);
        }
      }

      function pauseGame() {
        if (!isPaused) {
          clearInterval(timer);
          timer = null;
          backgroundMusic.pause();
          isPaused = true;
          document.getElementById("pauseButton").textContent = "RESUME GAME";
          showAchievement("‚è∏ Game Paused");
        } else {
          timer = setInterval(gameTick, 1000);
          if (isPlaying)
            backgroundMusic
              .play()
              .catch((e) => console.log("Resume play failed:", e));
          isPaused = false;
          document.getElementById("pauseButton").textContent =
            "EXIT/PAUSE GAME";
          showAchievement("‚ñ∂ Game Resumed");
        }
      }

      function startGame() {
        console.log("Starting game...");

        initAudio();

        mode = parseInt(
          document.querySelector(".mode-button.selected").dataset.mode
        );

        // Get player names
        p1Name = document.getElementById("player1Name").value || "Player 1";
        p2Name = document.getElementById("player2Name").value || "Player 2";

        // Set avatars
        const p1Selection = document.querySelector(
          "#avatarChoicesP1 .selected"
        );
        if (p1Selection) {
          player1.innerText = p1Selection.innerText;
        } else {
          player1.innerText = avatarOptions[0];
        }

        if (mode == 2) {
          const p2Selection = document.querySelector(
            "#avatarChoicesP2 .selected"
          );
          if (p2Selection) {
            player2.innerText = p2Selection.innerText;
          } else {
            player2.innerText = avatarOptions[1];
          }
        }

        // Show pause button
        document.getElementById("pauseButton").style.display = "block";

        // Start music if not playing
        if (!isPlaying) {
          isPlaying = true;
          updatePlayPauseButton();
          backgroundMusic
            .play()
            .catch((e) => console.log("Start music failed:", e));
        }

        // Hide start screen and show game
        startscreen.style.display = "none";

        initGame();
      }

      function initGame() {
        console.log("Initializing game state...");

        // Reset game state
        p1Score = 0;
        p2Score = 0;
        p1Lives = 3;
        p2Lives = 3;
        timeLeft = 40;
        level = 1;
        obstacleSpeed = 2;

        // Show appropriate players
        player1.style.display = "block";
        treasure.style.display = "block";

        if (mode == 2) {
          player2.style.display = "block";
        } else {
          player2.style.display = "none";
        }

        // Clear existing obstacles
        obstacles.forEach((obs) => obs.remove());
        obstacles = [];

        // Initialize positions
        placePlayers();
        placeTreasure();
        createObstacles();

        updateScoreboard();
        gameover.style.display = "none";

        // Start game timer
        clearInterval(timer);
        timer = setInterval(gameTick, 1000);

        console.log("Game started successfully");
      }

      // Game positioning and collision functions
      function randomPosition() {
        const game = document.getElementById("game");
        const x = Math.random() * (game.clientWidth - 60);
        const y = Math.random() * (game.clientHeight - 60);
        return { x, y };
      }

      function handleScreenWrap(x, y, element) {
        const game = document.getElementById("game");
        if (x < 0) x = game.clientWidth - 60;
        if (x > game.clientWidth - 60) x = 0;
        if (y < 0) y = game.clientHeight - 60;
        if (y > game.clientHeight - 60) y = 0;

        element.style.left = x + "px";
        element.style.top = y + "px";

        return { x, y };
      }

      function isOverlapping(rect1, rect2) {
        return !(
          rect1.top > rect2.bottom ||
          rect1.bottom < rect2.top ||
          rect1.left > rect2.right ||
          rect1.right < rect2.left
        );
      }

      function placePlayers() {
        // Place Player 1
        do {
          const p1Pos = randomPosition();
          p1X = p1Pos.x;
          p1Y = p1Pos.y;
          player1.style.left = p1X + "px";
          player1.style.top = p1Y + "px";
        } while (false); // Simple placement for now

        // Place Player 2 if in 2-player mode
        if (mode == 2) {
          do {
            const p2Pos = randomPosition();
            p2X = p2Pos.x;
            p2Y = p2Pos.y;
            player2.style.left = p2X + "px";
            player2.style.top = p2Y + "px";
          } while (
            isOverlapping(
              player2.getBoundingClientRect(),
              player1.getBoundingClientRect()
            )
          );
        }
      }

      function placeTreasure() {
        let valid = false;

        // Select random treasure type based on rarity
        const rand = Math.random();
        let selectedType = treasureTypes.COIN;
        let cumulative = 0;

        for (const type of Object.values(treasureTypes)) {
          cumulative += type.rarity;
          if (rand <= cumulative) {
            selectedType = type;
            break;
          }
        }

        treasure.innerText = selectedType.emoji;
        treasure.dataset.points = selectedType.points;
        treasure.dataset.type = Object.keys(treasureTypes).find(
          (key) => treasureTypes[key] === selectedType
        );

        while (!valid) {
          const pos = randomPosition();
          treasure.style.left = pos.x + "px";
          treasure.style.top = pos.y + "px";

          let overlaps = false;
          if (
            isOverlapping(
              treasure.getBoundingClientRect(),
              player1.getBoundingClientRect()
            )
          )
            overlaps = true;
          if (
            mode == 2 &&
            isOverlapping(
              treasure.getBoundingClientRect(),
              player2.getBoundingClientRect()
            )
          )
            overlaps = true;

          if (!overlaps) {
            valid = true;
          }
        }
      }

      function createObstacles() {
        let currentObstacleCount;
        if (level >= 13) {
          currentObstacleCount = 8;
        } else if (level >= 9) {
          currentObstacleCount = 6;
        } else if (level >= 6) {
          currentObstacleCount = 5;
        } else if (level >= 4) {
          currentObstacleCount = 4;
        } else if (level >= 3) {
          currentObstacleCount = 3;
        } else {
          currentObstacleCount = 2;
        }

        obstacles.forEach((obs) => obs.remove());
        obstacles = [];

        const allObstacles = ["üêä", "üî•", "ü••"];
        for (let i = 0; i < currentObstacleCount; i++) {
          const obs = document.createElement("div");
          obs.className = "obstacle sprite";
          obs.innerText =
            allObstacles[Math.floor(Math.random() * allObstacles.length)];
          gameContainer.appendChild(obs);
          obstacles.push(obs);
        }

        placeObstacles();
      }

      function placeObstacles() {
        obstacles.forEach((obs) => {
          placeObstacle(obs);
        });
      }

      function placeObstacle(obs) {
        let valid = false;
        let attempts = 0;
        const maxAttempts = 100;

        while (!valid && attempts < maxAttempts) {
          attempts++;
          const pos = randomPosition();
          obs.style.left = pos.x + "px";
          obs.style.top = pos.y + "px";

          let overlaps = false;

          // Check overlap with player 1
          if (
            isOverlapping(
              obs.getBoundingClientRect(),
              player1.getBoundingClientRect()
            )
          ) {
            overlaps = true;
          }

          // Check overlap with player 2
          if (
            mode == 2 &&
            isOverlapping(
              obs.getBoundingClientRect(),
              player2.getBoundingClientRect()
            )
          ) {
            overlaps = true;
          }

          // Check overlap with treasure
          if (
            isOverlapping(
              obs.getBoundingClientRect(),
              treasure.getBoundingClientRect()
            )
          ) {
            overlaps = true;
          }

          // Check overlap with other obstacles
          obstacles.forEach((otherObs) => {
            if (
              otherObs !== obs &&
              isOverlapping(
                obs.getBoundingClientRect(),
                otherObs.getBoundingClientRect()
              )
            ) {
              overlaps = true;
            }
          });

          if (!overlaps) {
            valid = true;
          }
        }

        obs.dataset.dx = (Math.random() < 0.5 ? -1 : 1) * obstacleSpeed;
      }

      function moveObstacles() {
        const game = document.getElementById("game");
        obstacles.forEach((obs) => {
          const currentLeft = parseFloat(obs.style.left);
          const currentTop = parseFloat(obs.style.top);
          const dx = parseFloat(obs.dataset.dx);

          // Move horizontally
          let newLeft = currentLeft + dx;

          // Bounce off walls
          if (newLeft <= 0 || newLeft >= game.clientWidth - 60) {
            obs.dataset.dx = -dx;
            newLeft = currentLeft - dx;
          }

          // Apply movement
          obs.style.left = newLeft + "px";

          // If level 5+, add tracking
          if (level >= 5) {
            const target =
              mode === 2 ? (Math.random() < 0.5 ? player1 : player2) : player1;

            const targetRect = target.getBoundingClientRect();
            const obsRect = obs.getBoundingClientRect();

            // Calculate direction to player
            const tdx = targetRect.left - obsRect.left;
            const tdy = targetRect.top - obsRect.top;
            const dist = Math.sqrt(tdx * tdx + tdy * tdy);

            if (dist < levelSettings.trackingRange) {
              const strength =
                levelSettings.baseTrackingStrength +
                (level - 5) * levelSettings.trackingLevelBonus;

              const moveY = (tdy / dist) * strength;
              obs.style.top = currentTop + moveY + "px";
            }
          }
        });
      }

      function updateScoreboard() {
        // Update stats displays
        document.getElementById("levelDisplay").textContent = level || 1;
        document.getElementById("highScoreDisplay").textContent =
          highScore || 0;
        document.getElementById("timeDisplay").textContent = timeLeft || 0;

        // Update player stats
        const playerStatsHtml = `
        <div>${p1Name || "Player 1"}: ${p1Score || 0} points ‚ù§Ô∏è ${
          p1Lives || 0
        } Lives</div>
        ${
          mode == 2
            ? `<div>${p2Name || "Player 2"}: ${p2Score || 0} points ‚ù§Ô∏è ${
                p2Lives || 0
              } Lives</div>`
            : ""
        }
      `;
        document.getElementById("playerStats").innerHTML = playerStatsHtml;
      }

      function showAchievement(text) {
        achievementBox.innerText = text;
        achievementBox.style.display = "block";
        playAudio(achievementSound);
        setTimeout(() => (achievementBox.style.display = "none"), 3000);
      }

      function playTreasureSound(treasureType) {
        const soundId = treasureType.sound;
        const audio = document.getElementById(soundId);
        if (audio) {
          playAudio(audio);
        }
      }

      function updatePlayerDirection(player, direction) {
        if (player === player1) {
          if (direction === "left" && p1Direction !== "left") {
            player.style.transform = "scaleX(-1)";
            p1Direction = "left";
          } else if (direction === "right" && p1Direction !== "right") {
            player.style.transform = "scaleX(1)";
            p1Direction = "right";
          }
        } else if (player === player2) {
          if (direction === "left" && p2Direction !== "left") {
            player.style.transform = "scaleX(-1)";
            p2Direction = "left";
          } else if (direction === "right" && p2Direction !== "right") {
            player.style.transform = "scaleX(1)";
            p2Direction = "right";
          }
        }
      }

      // Game loop and main functions
      function gameTick() {
        try {
          if (timeLeft > 0 && (p1Lives > 0 || (mode == 2 && p2Lives > 0))) {
            timeLeft--;
            moveObstacles();
            updateScoreboard();
          } else {
            endGame();
          }
        } catch (error) {
          console.error("Game tick error:", error);
          clearInterval(timer);
          timer = null;
        }
      }

      function checkTreasureCollision() {
        if (
          isOverlapping(
            player1.getBoundingClientRect(),
            treasure.getBoundingClientRect()
          )
        ) {
          const points = parseInt(treasure.dataset.points) || 1;
          const treasureType = treasureTypes[treasure.dataset.type];
          p1Score += points;
          placeTreasure();
          playTreasureSound(treasureType);

          if (p1Score % 5 === 0) {
            levelUp();
            timeLeft += 10;
            showAchievement("üéâ " + p1Name + " gets a bonus! +10s added!");
          }

          if (p1Score >= 15 && p1Score % 5 === 0) {
            timeLeft += 5;
            showAchievement("‚è±Ô∏è " + p1Name + " gets a time bonus! +5s added!");
          }
        }

        if (
          mode == 2 &&
          isOverlapping(
            player2.getBoundingClientRect(),
            treasure.getBoundingClientRect()
          )
        ) {
          const points = parseInt(treasure.dataset.points) || 1;
          const treasureType = treasureTypes[treasure.dataset.type];
          p2Score += points;
          placeTreasure();
          playTreasureSound(treasureType);

          if (p2Score % 5 === 0) {
            levelUp();
            timeLeft += 10;
            showAchievement("üéâ " + p2Name + " gets a bonus! +10s added!");
          }

          if (p2Score >= 15 && p2Score % 5 === 0) {
            timeLeft += 5;
            showAchievement("‚è±Ô∏è " + p2Name + " gets a time bonus! +5s added!");
          }
        }
        updateScoreboard();
      }

      function checkObstacleCollision() {
        obstacles.forEach((obs) => {
          if (
            isOverlapping(
              player1.getBoundingClientRect(),
              obs.getBoundingClientRect()
            )
          ) {
            p1Lives--;
            placeObstacle(obs); // Only reposition this specific obstacle
            playAudio(obstacleSound);
            if (p1Lives === 1)
              showAchievement(
                "üõ°Ô∏è " + p1Name + " is a Survivor! Only 1 life left!"
              );
          }
          if (
            mode == 2 &&
            isOverlapping(
              player2.getBoundingClientRect(),
              obs.getBoundingClientRect()
            )
          ) {
            p2Lives--;
            placeObstacle(obs); // Only reposition this specific obstacle
            playAudio(obstacleSound);
            if (p2Lives === 1)
              showAchievement(
                "üõ°Ô∏è " + p2Name + " is a Survivor! Only 1 life left!"
              );
          }
        });

        if (p1Lives <= 0 && (mode == 1 || p2Lives <= 0)) endGame();
        updateScoreboard();
      }

      function levelUp() {
        level++;
        showLevelUpNotification(level);

        if (level >= 4) {
          obstacleSpeed = 3;
        }
        if (level >= 7) {
          obstacleSpeed++;
        }
        if (level === 6) {
          p1Lives++;
          if (mode == 2) p2Lives++;
          showAchievement("üíñ Bonus Life! +1 life added!");
        }

        createObstacles();
        if (level === 3) showAchievement("‚ö° Speed Demon! Level 3 reached!");
      }

      function showLevelUpNotification(level) {
        const levelNotification = document.createElement("div");
        levelNotification.className = "level-up";
        levelNotification.textContent = `Level ${level}! üéÆ`;
        gameContainer.appendChild(levelNotification);

        setTimeout(() => {
          levelNotification.remove();
        }, 2000);
      }

      function endGame() {
        clearInterval(timer);
        backgroundMusic.pause();
        playAudio(gameOverSound);

        let message = `Game Over! ${p1Name}: ${p1Score}`;
        if (mode == 2) message += `, ${p2Name}: ${p2Score}`;

        let winner =
          p1Score > p2Score ? p1Name : p2Score > p1Score ? p2Name : "Tie";
        if (mode == 2) message += `. Winner: ${winner}`;

        let best = Math.max(p1Score, p2Score || 0);
        if (best > highScore) {
          highScore = best;
          localStorage.setItem("treasureHighScore", highScore);
          message += " üéâ NEW HIGH SCORE!";
        }

        gameover.style.display = "block";
        gameover.innerHTML = `
        ${message}<br><br>
        <button onclick="initGame()">Play Again</button>
        <button onclick="exitToMenu()">Main Menu</button>
      `;
      }

      function exitToMenu() {
        clearInterval(timer);
        backgroundMusic.pause();
        backgroundMusic.currentTime = 0;

        // Hide game elements
        player1.style.display = "none";
        player2.style.display = "none";
        treasure.style.display = "none";
        document.getElementById("pauseButton").style.display = "none";

        // Remove obstacles
        obstacles.forEach((obs) => obs.remove());
        obstacles = [];

        // Show start screen
        startscreen.style.display = "block";
        gameover.style.display = "none";

        // Reset music button
        isPlaying = false;
        updatePlayPauseButton();
      }

      // Movement controls
      window.addEventListener("keydown", (e) => {
        if (timeLeft <= 0 || (p1Lives <= 0 && (mode == 1 || p2Lives <= 0)))
          return;
        if (e.key === "Escape") {
          pauseGame();
          return;
        }

        // Player 1 movement
        let p1Moved = false;
        if (e.key === "ArrowRight") {
          p1X += moveStep;
          updatePlayerDirection(player1, "right");
          p1Moved = true;
        }
        if (e.key === "ArrowLeft") {
          p1X -= moveStep;
          updatePlayerDirection(player1, "left");
          p1Moved = true;
        }
        if (e.key === "ArrowUp") {
          p1Y -= moveStep;
          p1Moved = true;
        }
        if (e.key === "ArrowDown") {
          p1Y += moveStep;
          p1Moved = true;
        }

        // Apply Player 1 movement with screen wrap
        if (p1Moved) {
          const pos = handleScreenWrap(p1X, p1Y, player1);
          p1X = pos.x;
          p1Y = pos.y;
        }

        // Player 2 movement
        let p2Moved = false;
        if (mode == 2) {
          if (e.key === "d" || e.key === "D") {
            p2X += moveStep;
            updatePlayerDirection(player2, "right");
            p2Moved = true;
          }
          if (e.key === "a" || e.key === "A") {
            p2X -= moveStep;
            updatePlayerDirection(player2, "left");
            p2Moved = true;
          }
          if (e.key === "w" || e.key === "W") {
            p2Y -= moveStep;
            p2Moved = true;
          }
          if (e.key === "s" || e.key === "S") {
            p2Y += moveStep;
            p2Moved = true;
          }

          // Apply Player 2 movement with screen wrap
          if (p2Moved) {
            const pos = handleScreenWrap(p2X, p2Y, player2);
            p2X = pos.x;
            p2Y = pos.y;
          }
        }

        if (p1Moved || p2Moved) {
          checkTreasureCollision();
          checkObstacleCollision();
        }
      });

      // Initialize when page loads
      document.addEventListener("DOMContentLoaded", () => {
        console.log("DOM loaded, initializing game...");
        initializeGame();
      });

      // Also initialize immediately if DOM is already loaded
      if (document.readyState === "loading") {
        // Do nothing, will be handled by DOMContentLoaded
      } else {
        // DOM is already loaded
        initializeGame();
      }
    </script>
  </body>
</html>
