# Story 1.1: Fix Real-Time Display Updates

## Status

InProgress

## Story

**As a** player,  
**I want** time, points, and lives to update immediately when they change,  
**so that** I have real-time feedback about my game state and can make informed decisions.

## Acceptance Criteria

1. Time counter decreases visually every second during gameplay, updating the display immediately
2. Points counter updates immediately when a treasure is collected, showing the new score without delay
3. Lives counter updates immediately when a life is lost or gained, reflecting the change instantly
4. All display updates work correctly in single-player mode
5. All display updates work correctly in two-player mode (both players' stats update independently)
6. Display updates occur within one frame (16ms) of the triggering event
7. No performance degradation from increased update frequency

## Tasks / Subtasks

- [x] Task 1: Add immediate display update calls after score changes (AC: 2, 4, 5)

  - [x] Add `updateDisplay()` call after `p1Score += pointsEarned;` in Player 1 treasure collection (line ~3385)
  - [x] Add `updateDisplay()` call after `p2Score += pointsEarned;` in Player 2 treasure collection (line ~3427)
  - [ ] Verify both single-player and two-player modes update correctly
  - [ ] Test that points display updates immediately when treasure is collected

- [x] Task 2: Add immediate display update calls after lives changes (AC: 3, 4, 5)

  - [x] Add `updateDisplay()` call after `p1Lives--;` in Player 1 obstacle collision (line ~3515)
  - [x] Add `updateDisplay()` call after `p2Lives--;` in Player 2 obstacle collision (line ~3570)
  - [x] Add `updateDisplay()` call after `p1Lives++;` in level 6 bonus life (line ~3662)
  - [x] Add `updateDisplay()` call after `p2Lives++;` in level 6 bonus life (line ~3663)
  - [x] Add `updateDisplay()` call after `p1Lives++;` in checkLevelProgress bonus life (line ~3728)
  - [x] Add `updateDisplay()` call after `p2Lives++;` in checkLevelProgress bonus life (line ~3729)
  - [ ] Verify both single-player and two-player modes update correctly
  - [ ] Test that lives display updates immediately when lives change

- [x] Task 3: Verify time counter updates correctly (AC: 1)

  - [x] Review `gameTick()` function to ensure `updateDisplay()` is called after `timeLeft--` (line ~3758)
  - [x] Added `updateDisplay()` calls after `timeLeft += 10` in levelUp() and checkLevelProgress() functions
  - [ ] Verify time counter updates every second during gameplay
  - [ ] Test that time display shows countdown correctly
  - [ ] Verify time updates work in both single-player and two-player modes

- [x] Task 4: Performance optimization and testing (AC: 6, 7)

  - [x] Verify `updateDisplay()` function is efficient (uses direct DOM updates, no unnecessary operations)
  - [ ] Test that multiple rapid updates don't cause performance issues
  - [ ] Verify game maintains 60fps during active gameplay
  - [ ] Test display updates occur within 16ms of triggering event

- [ ] Task 5: Integration verification (AC: 4, 5)
  - [ ] Test all display updates in single-player mode
  - [ ] Test all display updates in two-player mode
  - [ ] Verify existing game mechanics (treasure collection, obstacle collision, level progression) continue to work
  - [ ] Verify debug logging system continues to log events correctly
  - [ ] Verify localStorage leaderboard functionality remains unaffected

## Dev Notes

### Current Implementation Analysis

**File Location:** `play_index.html` (single monolithic file, ~4,320 lines)

**Current Display Update Function:**

- Function `updateDisplay()` located at line ~3639
- Updates DOM elements: `timeDisplay`, `levelDisplay`, `highScoreDisplay`, `playerStats`
- Currently only called in `gameTick()` function (line ~3768) which runs every 1000ms

**Problem Identified:**

1. **Score Updates**: When treasures are collected:

   - Player 1: `p1Score += pointsEarned;` at line ~3385 (NO `updateDisplay()` call)
   - Player 2: `p2Score += pointsEarned;` at line ~3427 (NO `updateDisplay()` call)
   - Only `updateDebugPanel()` is called, not `updateDisplay()`

2. **Lives Updates**: When lives change:

   - Player 1 obstacle hit: `p1Lives--;` at line ~3515 (NO `updateDisplay()` call)
   - Player 2 obstacle hit: `p2Lives--;` at line ~3570 (NO `updateDisplay()` call)
   - Bonus life at level 6: `p1Lives++;` at line ~3662 (NO `updateDisplay()` call)
   - Bonus life at level 6: `p2Lives++;` at line ~3663 (NO `updateDisplay()` call)
   - Bonus life in checkLevelProgress: `p1Lives++;` at line ~3728 (NO `updateDisplay()` call)
   - Bonus life in checkLevelProgress: `p2Lives++;` at line ~3729 (NO `updateDisplay()` call)
   - Only `updateDebugPanel()` is called, not `updateDisplay()`

3. **Time Updates**:
   - `timeLeft--` at line ~3758 in `gameTick()` function
   - `updateDisplay()` IS called at line ~3768, so time should update
   - However, verify this is working correctly

**Key Functions:**

- `updateDisplay()`: Lines ~3639-3649 - Updates all display elements
- `checkCollisions()`: Lines ~3365+ - Handles treasure and obstacle collisions
- `gameTick()`: Lines ~3756-3778 - Main game loop, runs every 1000ms
- `checkLevelProgress()`: Lines ~3688-3754 - Handles level progression and bonus lives

**Game State Variables:**

- `p1Score`, `p2Score`: Player scores (updated when treasures collected)
- `p1Lives`, `p2Lives`: Player lives (updated on collision or bonus)
- `timeLeft`: Game timer (decremented in gameTick)
- `level`: Current level (updated in checkLevelProgress)
- `mode`: Game mode (1 = single player, 2 = two player)

**DOM Elements Updated:**

- `timeDisplay`: Shows remaining time
- `levelDisplay`: Shows current level
- `highScoreDisplay`: Shows high score
- `playerStats`: Shows player name, points, and lives (formatted HTML string)

### Technical Constraints

- **Single-file architecture**: All code in `play_index.html`, maintain existing structure
- **No build process**: Direct JavaScript execution in browser
- **Performance requirement**: Must maintain 60fps, updates must be <16ms
- **Browser compatibility**: Works in Chrome, Firefox, Safari, Edge
- **Existing patterns**: Follow current code style and patterns

### Implementation Approach

1. **Add `updateDisplay()` calls immediately after value changes:**

   - After score updates in treasure collection
   - After lives changes in collision handling
   - After bonus life grants

2. **Maintain existing `updateDisplay()` call in `gameTick()`:**

   - This ensures time counter continues to update every second
   - Also serves as a backup/sync mechanism

3. **No changes to `updateDisplay()` function itself:**

   - Function is already efficient (direct DOM updates)
   - No need to modify its implementation

4. **Testing strategy:**
   - Test in both single-player and two-player modes
   - Verify immediate visual updates
   - Check performance impact
   - Verify existing functionality unaffected

### Testing

**Test File Location:** N/A - Manual testing in browser (no test framework)

**Testing Standards:**

- Test in both single-player and two-player modes
- Verify visual updates occur immediately
- Check browser console for errors
- Use existing debug panel to verify values
- Test performance with browser DevTools

**Specific Test Cases:**

1. Collect treasure → verify points update immediately
2. Hit obstacle → verify lives update immediately
3. Reach level 6 → verify bonus life updates immediately
4. Play for 10 seconds → verify time counter updates every second
5. Two-player mode → verify both players' stats update independently
6. Rapid treasure collection → verify no performance degradation
7. Verify existing game mechanics still work correctly

**Testing Tools:**

- Browser DevTools for performance monitoring
- Existing debug panel (`updateDebugPanel()`) for value verification
- Visual inspection for immediate UI updates

### Integration Verification

**IV1:** Verify existing game mechanics (treasure collection, obstacle collision, level progression) continue to work correctly after display update changes

**IV2:** Verify debug logging system continues to log events correctly with immediate display updates

**IV3:** Verify performance impact is minimal - game maintains 60fps during active gameplay

**IV4:** Verify localStorage leaderboard functionality remains unaffected by display update changes

## Change Log

| Date       | Version | Description                           | Author      |
| ---------- | ------- | ------------------------------------- | ----------- |
| 2025-11-16 | 1.0     | Initial story creation                | SM (Bob)    |
| 2025-11-16 | 1.1     | Implemented real-time display updates | Dev (James) |

## Dev Agent Record

### Agent Model Used

Composer (Cursor AI)

### Debug Log References

- No errors found in linter check
- All code changes verified syntactically correct

### Completion Notes List

**Task 1 - Score Updates:**

- Added `updateDisplay()` call after `p1Score += pointsEarned;` at line 3386
- Added `updateDisplay()` call after `p2Score += pointsEarned;` at line 3429
- Both calls placed immediately after score update, before logging

**Task 2 - Lives Updates:**

- Added `updateDisplay()` call after `p1Lives--;` at line 3518 (obstacle collision)
- Added `updateDisplay()` call after `p2Lives--;` at line 3574 (obstacle collision)
- Added `updateDisplay()` call after bonus life grants in `levelUp()` function at line 3668
- Added `updateDisplay()` call after bonus life grants in `checkLevelProgress()` function at line 3735
- All calls placed immediately after lives change

**Task 3 - Time Updates:**

- Verified `updateDisplay()` is called in `gameTick()` after `timeLeft--` at line 3774
- Added `updateDisplay()` call after `timeLeft += 10` in `levelUp()` function at line 3664
- Added `updateDisplay()` call after `timeLeft += 10` in `checkLevelProgress()` function at line 3723
- Ensures time updates immediately when leveling up

**Task 4 - Performance:**

- Verified `updateDisplay()` function uses efficient direct DOM updates (getElementById, textContent, innerHTML)
- No unnecessary operations or loops
- Function execution should be well under 16ms threshold

**Implementation Summary:**

- Total of 8 `updateDisplay()` calls added
- All placed immediately after value changes for real-time feedback
- Maintained existing `updateDisplay()` call in `gameTick()` for time counter
- No changes to `updateDisplay()` function itself (already efficient)
- All code changes follow existing patterns and style

**Testing Required:**

- Manual testing needed to verify visual updates occur immediately
- Performance testing needed to confirm no frame drops
- Integration testing needed to verify existing functionality unaffected

### File List

**Modified Files:**

- `play_index.html` - Added 8 `updateDisplay()` calls for real-time display updates
  - Line 3386: After Player 1 score update
  - Line 3429: After Player 2 score update
  - Line 3518: After Player 1 lives decrease (obstacle collision)
  - Line 3574: After Player 2 lives decrease (obstacle collision)
  - Line 3664: After time increase in levelUp()
  - Line 3668: After bonus life in levelUp()
  - Line 3723: After time increase in checkLevelProgress()
  - Line 3735: After bonus life in checkLevelProgress()

## QA Results

_To be filled by QA Agent after review_
