# Story 1.2: Fix Collision Detection for Treasure Collection

## Status

InProgress

## Story

**As a** player,  
**I want** treasure collection to work accurately when my character visually overlaps with treasure,  
**so that** I can reliably collect treasures and progress through levels.

## Acceptance Criteria

1. Treasure collection triggers when player character fully overlaps treasure (not just visual effects)
2. Collision detection ignores visual effects (flame animations, etc.) and only checks actual character/treasure overlap
3. Buffer-based collision system continues to work but accurately detects overlaps
4. Collision detection works correctly for Player 1 in single-player mode
5. Collision detection works correctly for both players in two-player mode
6. Collision detection maintains current performance characteristics
7. Visual collision matches actual hit detection (what player sees is what registers)

## Tasks / Subtasks

- [x] Task 1: Investigate current collision detection implementation (AC: 1, 2, 7)

  - [x] Review `isOverlappingWithBuffer()` function (lines ~3622-3632)
  - [x] Review `getBufferedRect()` function (lines ~3611-3618)
  - [x] Review treasure collision detection in `checkCollisions()` (lines ~3370-3408 for P1, ~3410-3450 for P2)
  - [x] Verified collision detection is called on every player movement (line ~4276)
  - [x] Identified issue: 10px buffer too aggressive - requires 20px total overlap for collision
  - [x] Verified `getBoundingClientRect()` only measures actual element, not CSS visual effects

- [x] Task 2: Fix treasure collision detection logic (AC: 1, 3, 4, 5)

  - [x] Verified `getBoundingClientRect()` returns correct values for player and treasure elements
  - [x] Reduced collision buffer from 10px to 5px for treasure (line ~1580)
  - [x] Collision detection checks actual character/treasure overlap using bounding rects
  - [ ] Test collision detection for Player 1 in single-player mode
  - [ ] Test collision detection for both players in two-player mode
  - [ ] Verify collision triggers when character visually overlaps treasure

- [x] Task 3: Ensure visual effects don't affect collision (AC: 2)

  - [x] Verified `getBoundingClientRect()` only measures actual element size, not CSS visual effects
  - [x] Confirmed visual effects (flames, animations) are CSS-based and don't affect bounding rect
  - [x] Collision detection uses actual element dimensions from `getBoundingClientRect()`
  - [ ] Test that flame animations around obstacles don't cause false collision detection

- [ ] Task 4: Verify collision system maintains performance (AC: 6)

  - [ ] Test collision detection performance with browser DevTools
  - [ ] Verify collision checks don't cause frame drops
  - [ ] Ensure `getBoundingClientRect()` calls are efficient
  - [ ] Test with multiple treasures and obstacles on screen

- [ ] Task 5: Integration verification (AC: 4, 5)
  - [ ] Verify obstacle collision detection continues to work correctly (not affected by treasure collision changes)
  - [ ] Verify power-up collection collision detection continues to work correctly
  - [ ] Verify collision cooldown system continues to function properly
  - [ ] Verify shield power-up immunity continues to work correctly
  - [ ] Test in both single-player and two-player modes

## Dev Notes

### Current Implementation Analysis

**File Location:** `play_index.html` (single monolithic file, ~4,320 lines)

**Collision Detection System:**

- **Buffer Constants**: `COLLISION_BUFFER` object at lines ~1578-1582

  - `obstacle: 22` - Requires 22px closer contact for obstacles
  - `treasure: 10` - 10px buffer for treasures (easier collection)
  - `powerup: 12` - 12px buffer for power-ups

- **Core Functions:**

  - `getBufferedRect(rect, buffer)`: Lines ~3611-3618 - Shrinks hitbox by buffer pixels on all sides
  - `isOverlappingWithBuffer(rect1, rect2, buffer)`: Lines ~3622-3632 - Checks collision with buffer
  - `isOverlapping(rect1, rect2)`: Lines ~3635-3637 - Zero-buffer collision check (backward compatibility)

- **Treasure Collision Detection:**
  - Player 1: Lines ~3370-3408 in `checkCollisions()` function
    - Uses `player1.getBoundingClientRect()` for player position
    - Uses `treasure.getBoundingClientRect()` for treasure position
    - Calls `isOverlappingWithBuffer(p1Rect, treasureRect, COLLISION_BUFFER.treasure)`
  - Player 2: Lines ~3410-3450 in `checkCollisions()` function
    - Same pattern as Player 1
    - Uses `player2.getBoundingClientRect()` for player position

**Problem Analysis:**
Based on user reports:

1. Player character visually on treasure but collision not detecting
2. Visual effects (flames) should not count as collision
3. Need full character overlap, not just visual effects

**Possible Issues:**

1. **Buffer too aggressive**: 10px buffer might be shrinking hitbox too much
2. **Bounding rect includes visual effects**: `getBoundingClientRect()` might include CSS transforms/animations
3. **Timing issue**: Collision check might happen before visual overlap
4. **Element positioning**: Player/treasure elements might have padding/margins affecting collision

**Key Variables:**

- `player1`, `player2`: Player DOM elements (emoji characters, 50px size)
- `treasure`: Treasure DOM element (emoji, varies by type)
- `COLLISION_BUFFER.treasure`: Currently 10px buffer

**Collision Check Flow:**

1. `checkCollisions()` called every frame (via `requestAnimationFrame` or game loop)
2. Gets bounding rects for player and treasure
3. Applies buffer using `getBufferedRect()`
4. Checks overlap using `isOverlappingWithBuffer()`
5. If overlap detected, triggers treasure collection

### Technical Constraints

- **Single-file architecture**: All code in `play_index.html`, maintain existing structure
- **Buffer system**: Must maintain existing buffer-based precision system
- **Performance requirement**: Collision checks run every frame, must be efficient
- **Visual accuracy**: Collision must match what player sees on screen
- **Browser compatibility**: `getBoundingClientRect()` works in all modern browsers

### Implementation Approach

1. **Debug current collision detection:**

   - Add console logging to see bounding rect values
   - Visual inspection of collision detection
   - Test with player directly on treasure

2. **Adjust collision detection if needed:**

   - May need to reduce treasure buffer (currently 10px)
   - May need to ensure bounding rects are calculated correctly
   - May need to account for element padding/margins

3. **Verify visual effects don't affect collision:**

   - Ensure `getBoundingClientRect()` only measures actual element
   - CSS transforms/animations shouldn't affect bounding rect
   - Visual effects (flames) are separate elements or CSS, not part of bounding rect

4. **Test thoroughly:**
   - Test with different treasure types
   - Test in both game modes
   - Verify performance impact

### Testing

**Test File Location:** N/A - Manual testing in browser (no test framework)

**Testing Standards:**

- Visual inspection of collision detection
- Browser console for debugging
- Use existing debug panel to verify collision events
- Test with different character/treasure combinations

**Specific Test Cases:**

1. Position player directly on treasure → verify collection triggers
2. Position player near treasure (not overlapping) → verify no false collection
3. Test with all treasure types (coin, silver, gold, gem)
4. Test in single-player mode
5. Test in two-player mode (both players)
6. Test with visual effects present (flames, animations)
7. Verify collision performance (no frame drops)
8. Test rapid movement near treasures

**Testing Tools:**

- Browser DevTools for element inspection
- Console logging for collision debugging
- Visual inspection for collision accuracy
- Existing debug panel for collision event verification

### Integration Verification

**IV1:** Verify existing obstacle collision detection continues to work correctly (not affected by treasure collision changes)

**IV2:** Verify power-up collection collision detection continues to work correctly

**IV3:** Verify collision cooldown system continues to function properly

**IV4:** Verify shield power-up immunity continues to work correctly

## Change Log

| Date       | Version | Description                              | Author      |
| ---------- | ------- | ---------------------------------------- | ----------- |
| 2025-11-16 | 1.0     | Initial story creation                   | SM (Bob)    |
| 2025-11-16 | 1.1     | Reduced treasure collision buffer to 5px | Dev (James) |

## Dev Agent Record

### Agent Model Used

Composer (Cursor AI)

### Debug Log References

- No errors found in linter check
- Collision detection logic verified syntactically correct

### Completion Notes List

**Task 1 - Investigation:**

- Reviewed collision detection functions - all working correctly
- Verified `checkCollisions()` is called on every player movement (line 4276)
- Identified root cause: 10px buffer too aggressive
- With 10px buffer on both rects, requires 20px total overlap for collision
- Verified `getBoundingClientRect()` only measures actual element, not CSS effects

**Task 2 - Fix Implementation:**

- Reduced `COLLISION_BUFFER.treasure` from 10px to 5px (line 1580)
- This reduces required overlap from 20px to 10px total
- Makes treasure collection easier while maintaining precision
- Collision detection logic unchanged - only buffer value adjusted

**Task 3 - Visual Effects Verification:**

- Confirmed `getBoundingClientRect()` only returns actual element dimensions
- CSS visual effects (flames, box-shadow, animations) don't affect bounding rect
- Collision detection uses actual element size, ensuring accurate detection

**Implementation Summary:**

- Reduced treasure collision buffer from 10px to 5px
- This makes treasure collection easier when player visually overlaps treasure
- Maintains buffer-based precision system
- No changes to collision detection logic itself
- Visual effects already don't affect collision (verified)

**Testing Required:**

- Manual testing needed to verify treasure collection works when player visually overlaps
- Test with different treasure types
- Test in both single-player and two-player modes
- Verify no false positives (collection when not overlapping)

### File List

**Modified Files:**

- `play_index.html` - Reduced treasure collision buffer from 10px to 5px
  - Line 1580: Changed `treasure: 10` to `treasure: 5` in COLLISION_BUFFER object

## QA Results

_To be filled by QA Agent after review_
